<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è§†é¢‘è´¨é‡æ£€æµ‹ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif; min-height: 100vh; display: flex; flex-direction: column; margin: 0; }
        .wrapper { flex: 1; display: flex; flex-direction: column; }
        .sidebar { min-height: 100vh; background: #212529; color: white; padding-top: 20px; }
        .sidebar a { color: rgba(255,255,255,.7); text-decoration: none; padding: 12px 20px; display: block; border-left: 3px solid transparent; display: flex; align-items: center; cursor: pointer; }
        .sidebar a i { margin-right: 10px; font-size: 1.1rem; }
        .sidebar a:hover, .sidebar a.active { background: #2c3034; border-left-color: #0d6efd; color: white; }
        .main-content { padding: 30px; flex: 1; }
        .card-custom { border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background: white; margin-bottom: 20px; }
        .spinner { display: inline-block; width: 1rem; height: 1rem; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite; margin-right: 5px; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .footer-info { text-align: center; padding: 10px; color: #adb5bd; font-size: 0.85rem; margin-top: auto; border-top: 1px solid #e9ecef; background-color: #fff; width: 100%; }
        .login-footer { position: absolute; bottom: 10px; width: 100%; text-align: center; color: #adb5bd; font-size: 0.8rem; background: transparent; }
        .login-input-custom::placeholder { font-size: 0.95rem; opacity: 0.6; }
        .login-icon-box { width: 80px; height: 80px; background: #e7f1ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto; }
        
        /* è·¯å¾„æ˜¾ç¤ºæ ·å¼ */
        .error-path-box { background: #f8d7da; border: 1px solid #f5c2c7; border-radius: 6px; padding: 20px; margin: 15px 0; text-align: left; }
        .path-display { font-family: Consolas, Monaco, 'Courier New', monospace; font-weight: bold; color: #842029; font-size: 1.1rem; word-break: break-all; }
        .path-label { font-size: 0.85rem; color: #a94442; margin-bottom: 8px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="app" class="wrapper">
    <div v-if="!user" class="container d-flex justify-content-center align-items-center" style="height: 90vh;">
        <div class="card card-custom p-5 shadow-lg" style="width: 450px; position: relative;">
            <div class="text-center mb-5">
                <div class="login-icon-box"><i class="bi bi-camera-reels-fill" style="font-size: 2.5rem; color: #0d6efd;"></i></div>
                <h3 class="text-primary fw-bold">ç³»ç»Ÿç™»å½•</h3>
                <p class="text-muted small">è§†é¢‘è´¨é‡æ£€æµ‹å¹³å°</p>
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold">ç”¨æˆ· ID</label>
                <input type="text" ref="loginField" v-model="loginInput" class="form-control form-control-lg border-start-0 ps-2 login-input-custom" placeholder=" ä¾‹å¦‚: ID001" @keyup.enter="login" style="border-left:none;">
            </div>
            <button @click="login" class="btn btn-primary w-100 btn-lg">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
        <div class="login-footer">
            <p class="mb-0">ç½‘é¡µå¼€å‘ï¼šå•ä½³å¿†</p>
            <p class="mb-0">æŒ‡å¯¼è€å¸ˆï¼šå¼ é¸¿æ–‡@BNUå…·èº«è¿åŠ¨æ™ºèƒ½ç ”ç©¶ç»„</p>
        </div>
    </div>

    <template v-else>
        <div class="container-fluid p-0">
            <div class="row g-0">
                <div class="col-md-2 sidebar">
                    <h5 class="text-center mb-4"><i class="bi bi-film"></i> è§†é¢‘æ£€æµ‹ç³»ç»Ÿ</h5>
                    <div class="text-center mb-4 text-white-50 small">
                        <i class="bi bi-person-circle fs-4 mb-1 d-block text-white"></i>
                        å½“å‰ç”¨æˆ·: <span class="text-white">{{ user }}</span>
                    </div>
                    <a @click="view='scan'" :class="{active: view==='scan'}"><i class="bi bi-speedometer2"></i> æ£€æµ‹ä¸­å¿ƒ</a>
                    <a @click="view='history'" :class="{active: view==='history'}"><i class="bi bi-clock-history"></i> å†å²è®°å½•</a>
                    <a @click="logout" class="text-danger mt-5"><i class="bi bi-box-arrow-right"></i> é€€å‡ºç™»å½•</a>
                </div>

                <div class="col-md-10 d-flex flex-column" style="min-height: 100vh;">
                    <div class="main-content">
                        <div v-if="view==='scan'">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3 class="fw-bold text-dark"><i class="bi bi-grid-1x2-fill text-primary"></i> æ£€æµ‹æ§åˆ¶å°</h3>
                                <span class="badge bg-secondary px-3 py-2">æ ‡å‡†: 4K (4:3) | 30FPS</span>
                            </div>

                            <div class="card card-custom p-4">
                                <label class="form-label fw-bold">é€‰æ‹©ç›®å½•</label>
                                <div class="input-group">
                                    <button class="btn btn-secondary" @click="handleBrowse" :disabled="scanning">
                                        <span v-if="browsing" class="spinner"></span> ğŸ“‚æµè§ˆæ–‡ä»¶å¤¹
                                    </button>
                                    <input type="text" v-model="pickedPath" class="form-control bg-white" placeholder="è¯·é€‰æ‹©æˆ–ç²˜è´´æ–‡ä»¶å¤¹è·¯å¾„...">
                                    <button class="btn btn-primary px-5 fw-bold" @click="startScan" :disabled="scanning || !pickedPath">
                                        <span v-if="scanning" class="spinner"></span> 
                                        <i class="bi bi-search"></i> å¼€å§‹æ£€æµ‹
                                    </button>
                                </div>
                                <div class="mt-2" id="pathStatus" v-html="statusText"></div>
                            </div>

                            <div v-if="showResult" id="resultArea">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="card card-custom p-3 border-start border-success border-5">
                                            <h6 class="text-success text-uppercase">åˆæ ¼è§†é¢‘</h6>
                                            <h2 class="fw-bold">{{ passCount }}</h2>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card card-custom p-3 border-start border-danger border-5">
                                            <h6 class="text-danger text-uppercase">ä¸åˆæ ¼è§†é¢‘</h6>
                                            <h2 class="fw-bold">{{ failCount }}</h2>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card card-custom p-3 border-start border-info border-5">
                                            <h6 class="text-info text-uppercase">è§†é¢‘æ—¶é•¿ (HH:MM:SS)</h6>
                                            <div class="d-flex justify-content-between">
                                                <div><small class="text-muted d-block">æ€»æ—¶é•¿</small><span class="fw-bold fs-5">{{ summary.total_duration }}</span></div>
                                                <div><small class="text-success d-block">æœ‰æ•ˆæ—¶é•¿</small><span class="fw-bold fs-5 text-success">{{ summary.valid_duration }}</span></div>
                                                <div><small class="text-danger d-block">æ— æ•ˆæ—¶é•¿</small><span class="fw-bold fs-5 text-danger">{{ summary.invalid_duration }}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card card-custom p-4 mb-3 border-start border-warning border-5">
                                    <h5 class="fw-bold mb-3"><i class="bi bi-folder2-open text-warning"></i> æ–‡ä»¶å¤¹æ—¶é•¿ç»Ÿè®¡</h5>
                                    <div class="table-responsive" style="max-height: 200px;">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr><th>æ–‡ä»¶å¤¹åç§°</th><th>æ€»æ—¶é•¿</th><th class="text-success">æœ‰æ•ˆé‡‡é›†æ—¶é•¿</th><th>çŠ¶æ€</th></tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="f in folderResults">
                                                    <td class="fw-bold">{{ f.name }}</td><td>{{ f.duration_str }}</td><td class="text-success fw-bold">{{ f.valid_duration_str }}</td>
                                                    <td><span class="badge" :class="f.passed?'bg-success':'bg-danger'">{{ f.passed?'åˆæ ¼':'ä¸åˆæ ¼' }}</span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6"><div class="card card-custom h-100"><div class="card-header bg-danger text-white fw-bold">ä¸åˆæ ¼è§†é¢‘</div><div class="card-body p-0 table-responsive" style="max-height:500px;"><table class="table table-striped small mb-0"><thead><tr><th>æ–‡ä»¶å</th><th>åŸå› </th></tr></thead><tbody><tr v-for="v in failList"><td>{{v.filename}}</td><td class="text-danger">{{v.reason}}</td></tr></tbody></table></div></div></div>
                                    <div class="col-md-6"><div class="card card-custom h-100"><div class="card-header bg-success text-white fw-bold">åˆæ ¼è§†é¢‘</div><div class="card-body p-0 table-responsive" style="max-height:500px;"><table class="table table-striped small mb-0"><thead><tr><th>æ–‡ä»¶å</th><th>è¯¦æƒ…</th></tr></thead><tbody><tr v-for="v in passList"><td>{{v.filename}}</td><td>{{v.width}}x{{v.height}}, {{v.fps}}fps</td></tr></tbody></table></div></div></div>
                                </div>
                            </div>
                        </div>

                        <div v-if="view==='history'">
                            <div class="card card-custom p-4">
                                <h4><i class="bi bi-clock-history text-primary"></i> å†å²æ£€æµ‹è®°å½•</h4>
                                <table class="table table-hover mt-3 align-middle">
                                    <thead class="table-light"><tr><th>æ—¶é—´</th><th>ç”¨æˆ·</th><th>æ£€æµ‹è·¯å¾„</th><th>ç»“æœ</th></tr></thead>
                                    <tbody><tr v-for="h in historyData"><td>{{h.time}}</td><td>{{h.user}}</td><td class="text-muted small">{{h.path}}</td><td>{{h.pass_count}}/{{h.total}}</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="footer-info">
                        <p class="mb-1">ç½‘é¡µå¼€å‘ï¼šå•ä½³å¿†</p>
                        <p class="mb-0">æŒ‡å¯¼è€å¸ˆï¼šå¼ é¸¿æ–‡@BNUå…·èº«è¿åŠ¨æ™ºèƒ½ç ”ç©¶ç»„</p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <div class="modal fade" id="namingErrorModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-x-circle-fill"></i> ç›®å½•ç»“æ„ä¸è§„èŒƒ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <p class="text-secondary mb-3">ç³»ç»Ÿåœ¨æ£€æµ‹ä»¥ä¸‹æ–‡ä»¶æ—¶å‘ç°å±‚çº§å‘½åé”™è¯¯ï¼Œè¯·æ ¸å¯¹ç³»ç»Ÿè¯»å–åˆ°çš„è·¯å¾„ï¼š</p>
                    
                    <div v-if="detectedPath" class="error-path-box shadow-sm">
                        <div class="path-label"><i class="bi bi-hdd-network"></i> ç³»ç»Ÿå½“å‰è¯»å–åˆ°çš„ç›®å½•ç»“æ„ï¼š</div>
                        <div class="path-display">{{ detectedPath }}</div>
                    </div>

                    <hr class="my-4">
                    
                    <h6 class="fw-bold text-dark mb-3"><i class="bi bi-info-circle"></i> è¯·å¯¹ç…§ä¸‹æ–¹æ ‡å‡†ç»“æ„è¿›è¡Œä¿®æ”¹ï¼š</h6>
                    <img src="static/structure_guide.png" class="img-fluid border rounded shadow-sm" style="max-height: 250px;" alt="æ ‡å‡†ç»“æ„ç¤ºæ„å›¾">
                </div>
                <div class="modal-footer justify-content-center">
                    <button class="btn btn-secondary px-5" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const { createApp, ref, computed, onMounted, nextTick } = Vue;

createApp({
    setup() {
        const STANDARDS = { target_fps: 30, fps_tolerance: 0.5, format: ".mp4", min_width: 2800, min_height: 2100, target_ratio: 4/3, ratio_tolerance: 0.05 };
        const DURATION_Threshold_Folder = 6 * 3600; 
        const DURATION_Threshold_Avg = 7 * 3600;

        const user = ref(localStorage.getItem('qc_user') || '');
        const loginInput = ref('');
        const loginField = ref(null);
        const view = ref('scan');
        const browsing = ref(false);
        const scanning = ref(false);
        const pickedPath = ref('');
        const statusText = ref('');
        const showResult = ref(false);
        const videoResults = ref([]);
        const folderResults = ref([]);
        const summary = ref({ total_duration: '00:00:00', valid_duration: '00:00:00', invalid_duration: '00:00:00' });
        const globalStats = ref({ avg_duration_str: '00:00:00', avg_passed: false, qualified_days: 0 });
        const historyData = ref(JSON.parse(localStorage.getItem('qc_history') || '[]'));
        
        // å­˜å‚¨ç³»ç»Ÿè¯»åˆ°çš„é”™è¯¯è·¯å¾„å­—ç¬¦ä¸²
        const detectedPath = ref('');
        
        let currentDirHandle = null;

        onMounted(() => { if(!user.value) nextTick(() => loginField.value?.focus()); });

        const login = () => { if(loginInput.value.trim()){ user.value = loginInput.value.trim(); localStorage.setItem('qc_user', user.value); } };
        const logout = () => { user.value = ''; localStorage.removeItem('qc_user'); location.reload(); };

        const formatDuration = (s) => {
            const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        };

        const handleBrowse = async () => {
            try {
                browsing.value = true;
                currentDirHandle = await window.showDirectoryPicker();
                pickedPath.value = currentDirHandle.name;
            } catch (e) { console.warn("Browse cancelled"); }
            finally { browsing.value = false; }
        };

        const startScan = async () => {
            if(!currentDirHandle) return alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹");
            
            scanning.value = true;
            showResult.value = false;
            detectedPath.value = '';
            statusText.value = '<span class="text-primary">æ­£åœ¨æ‰«æåˆ†æ...</span>';
            
            try {
                const results = [];
                const folderDurationMap = new Map();
                const folderValidDurationMap = new Map();
                const pattern = /^(.+)-(\d{6})-(\d{2})\.(mp4|mov|avi|mkv)$/i;
                let foundVideos = false;

                const scan = async (dirHandle, pathStack = []) => {
                    for await (const entry of dirHandle.values()) {
                        if (entry.kind === 'directory') {
                            await scan(entry, [...pathStack, dirHandle]);
                        } else if (entry.kind === 'file' && /\.(mp4|mov|avi|mkv)$/i.test(entry.name)) {
                            foundVideos = true;
                            
                            // æ„å»ºå½“å‰ç³»ç»Ÿè¯»å–åˆ°çš„è·¯å¾„å­—ç¬¦ä¸²
                            const fullPathArr = [...pathStack, dirHandle, entry].map(h => h.name);
                            const currentFullPath = fullPathArr.join(' / ');

                            const match = entry.name.match(pattern);
                            const currentFolderName = dirHandle.name; 

                            // 1. æ ¡éªŒæ–‡ä»¶å
                            if(!match) {
                                detectedPath.value = currentFullPath;
                                new bootstrap.Modal(document.getElementById('namingErrorModal')).show();
                                throw new Error("STRUCTURE_ERROR");
                            }

                            const fileId = match[1];
                            const fileDate = match[2];
                            const expectedFolderName = `${fileId}-${fileDate}`;

                            // 2. æ ¡éªŒäºŒçº§ç›®å½•
                            if(currentFolderName !== expectedFolderName) {
                                detectedPath.value = currentFullPath;
                                new bootstrap.Modal(document.getElementById('namingErrorModal')).show();
                                throw new Error("STRUCTURE_ERROR");
                            }

                            // 3. æ ¡éªŒä¸€çº§ç›®å½• (IDå±‚)
                            if (pathStack.length > 0) {
                                const parentEntry = pathStack[pathStack.length - 1]; 
                                const parentName = parentEntry.name;
                                if (parentName !== fileId) {
                                    detectedPath.value = currentFullPath;
                                    new bootstrap.Modal(document.getElementById('namingErrorModal')).show();
                                    throw new Error("STRUCTURE_ERROR");
                                }
                            }

                            const info = await analyzeVideo(await entry.getFile());
                            results.push(info);
                            const folderKey = currentFolderName;
                            folderDurationMap.set(folderKey, (folderDurationMap.get(folderKey) || 0) + info.duration_sec);
                            if(info.passed) {
                                folderValidDurationMap.set(folderKey, (folderValidDurationMap.get(folderKey) || 0) + info.duration_sec);
                            }
                        }
                    }
                };

                await scan(currentDirHandle, []);

                if(!foundVideos) throw new Error("æœªæ‰¾åˆ°è§†é¢‘æ–‡ä»¶");

                // ç»Ÿè®¡è®¡ç®— (ä»£ç ä¿æŒä¸å˜)
                let totalQualifiedValidDur = 0;
                let qualifiedDaysCount = 0;
                const fResults = [];
                folderDurationMap.forEach((duration, folderName) => {
                    const validDuration = folderValidDurationMap.get(folderName) || 0;
                    const isPassed = validDuration >= DURATION_Threshold_Folder;
                    if(isPassed) { qualifiedDaysCount++; totalQualifiedValidDur += validDuration; }
                    fResults.push({ name: folderName, duration_str: formatDuration(duration), valid_duration_str: formatDuration(validDuration), passed: isPassed });
                });
                const totalSec = results.reduce((a, b) => a + b.duration_sec, 0);
                const validSec = results.filter(r => r.passed).reduce((a, b) => a + b.duration_sec, 0);

                videoResults.value = results;
                folderResults.value = fResults;
                summary.value = { total_duration: formatDuration(totalSec), valid_duration: formatDuration(validSec), invalid_duration: formatDuration(totalSec - validSec) };
                statusText.value = `<span class='text-success fw-bold'>æ£€æµ‹å®Œæˆ</span>`;
                showResult.value = true;
                saveHistory();

            } catch (e) {
                if(e.message === "STRUCTURE_ERROR") {
                    statusText.value = `<span class='text-danger fw-bold'>ç›®å½•ç»“æ„ä¸ç¬¦åˆè§„èŒƒ</span>`;
                } else {
                    statusText.value = `<span class='text-danger'>${e.message}</span>`;
                }
            } finally {
                scanning.value = false;
            }
        };

        const analyzeVideo = (file) => new Promise(res => {
            const v = document.createElement('video');
            v.preload = 'metadata';
            v.src = URL.createObjectURL(file);
            v.onloadedmetadata = () => {
                URL.revokeObjectURL(v.src);
                const d = v.duration || 0, w = v.videoWidth, h = v.videoHeight, r = w/h;
                let reasons = [];
                if(!file.name.toLowerCase().endsWith(STANDARDS.format)) reasons.push(`æ ¼å¼é”™è¯¯`);
                if(w < STANDARDS.min_width || h < STANDARDS.min_height) reasons.push(`åˆ†è¾¨ç‡ä¸è¶³`);
                if(Math.abs(r - STANDARDS.target_ratio) > STANDARDS.ratio_tolerance) reasons.push(`æ¯”ä¾‹é”™è¯¯`);
                res({ filename: file.name, width: w, height: h, fps: 30, duration_sec: d, duration_str: formatDuration(d), passed: reasons.length === 0, reason: reasons.join('|') || 'åˆæ ¼' });
            };
            v.onerror = () => res({ filename: file.name, duration_sec: 0, duration_str: '00:00:00', passed: false, reason: 'è¯»å–å¼‚å¸¸' });
        });

        const saveHistory = () => {
            const h = { time: new Date().toLocaleString(), user: user.value, path: pickedPath.value, total: videoResults.value.length, pass_count: videoResults.value.filter(r=>r.passed).length };
            historyData.value.unshift(h);
            localStorage.setItem('qc_history', JSON.stringify(historyData.value.slice(0, 50)));
        };

        return { 
            user, loginInput, loginField, view, browsing, scanning, pickedPath, statusText, showResult, folderResults, globalStats, historyData, summary,
            detectedPath, 
            login, logout, handleBrowse, startScan,
            passList: computed(() => videoResults.value.filter(r=>r.passed)),
            failList: computed(() => videoResults.value.filter(r=>!r.passed)),
            passCount: computed(() => videoResults.value.filter(r=>r.passed).length), 
            failCount: computed(() => videoResults.value.length - videoResults.value.filter(r=>r.passed).length)
        };
    }
}).mount('#app');
</script>
</body>
</html>
